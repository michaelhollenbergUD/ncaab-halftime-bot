name: NCAAB Under 10 Min Monitor

on:
  workflow_dispatch: # Allows manual trigger and API trigger

jobs:
  check-halftime:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Check for games under 10 minutes
      run: |
        # Get today's date in Eastern Time (YYYYMMDD format)
        # ESPN uses Eastern Time for college basketball games
        TODAY=$(TZ='America/New_York' date +%Y%m%d)
        
        # Fetch ESPN scoreboard data with groups parameter to get ALL games (not just top 25)
        # groups=50 gets all Division I games
        # dates parameter ensures we get today's games in Eastern Time
        response=$(curl -s "https://site.api.espn.com/apis/site/v2/sports/basketball/mens-college-basketball/scoreboard?groups=50&dates=$TODAY")
        
        # Save to file for processing
        echo "$response" > games.json
        
        # Create state file if it doesn't exist
        touch alerted_games.txt
        
        # Create Python script to process data
        cat << 'EOF' > check_halftime.py
        import json
        import os
        import urllib.request
        import urllib.parse
        from datetime import datetime
        
        # Read the games data
        with open('games.json', 'r') as f:
            data = json.load(f)
        
        # Read previously alerted games
        alerted_games = set()
        try:
            with open('alerted_games.txt', 'r') as f:
                content = f.read().strip()
                if content:
                    alerted_games = set(content.split(','))
        except:
            pass
        
        # Get current date for daily reset
        current_date = datetime.now().strftime('%Y%m%d')
        
        # Filter out old alerts (from previous days)
        alerted_games = {g for g in alerted_games if g.startswith(current_date)}
        
        # Check for halftime games
        halftime_games = []
        
        # Debug output
        print(f"\nðŸ“Š API Response Summary:")
        print(f"Total games found: {len(data.get('events', []))}")
        if data.get('events'):
            print(f"\nAll games in response:")
            for event in data['events']:
                competition = event['competitions'][0]
                status_detail = competition['status']['type']['detail']
                home_team = next((t for t in competition['competitors'] if t['homeAway'] == 'home'), None)
                away_team = next((t for t in competition['competitors'] if t['homeAway'] == 'away'), None)
                if home_team and away_team:
                    print(f"  - {away_team['team']['displayName']} @ {home_team['team']['displayName']} [{status_detail}]")
        
        if 'events' in data and data['events']:
            for event in data['events']:
                game_id = event['id']
                competition = event['competitions'][0]
                status = competition['status']['type']['name']
                status_detail = competition['status']['type']['detail']
                display_clock = competition['status'].get('displayClock', '')
                period = competition['status'].get('period', 0)
                
                # Create unique daily key (date + game_id)
                daily_game_key = f"{current_date}_{game_id}"
                
                # Check if game is in 2nd half (period 2) and has less than 10 minutes left
                # AND not already alerted today
                is_second_half = period == 2
                is_in_progress = status == 'STATUS_IN_PROGRESS'
                
                # Parse clock time (format is usually "MM:SS" like "9:45" or "5:23")
                time_under_10_min = False
                if display_clock and ':' in display_clock:
                    try:
                        parts = display_clock.split(':')
                        minutes = int(parts[0])
                        time_under_10_min = minutes < 10
                    except:
                        pass
                
                if is_second_half and is_in_progress and time_under_10_min and daily_game_key not in alerted_games:
                    home_team = next((t for t in competition['competitors'] if t['homeAway'] == 'home'), None)
                    away_team = next((t for t in competition['competitors'] if t['homeAway'] == 'away'), None)
                    
                    if home_team and away_team:
                        game = {
                            'id': game_id,
                            'daily_key': daily_game_key,
                            'away_team': away_team['team']['displayName'],
                            'away_score': away_team['score'],
                            'home_team': home_team['team']['displayName'],
                            'home_score': home_team['score'],
                            'broadcast': competition.get('broadcasts', [{}])[0].get('names', ['No TV info'])[0] if competition.get('broadcasts') else 'No TV info',
                            'time_remaining': display_clock
                        }
                        halftime_games.append(game)
                        alerted_games.add(daily_game_key)
        
        # Send notifications for each halftime game
        webhook_url = os.environ.get('SLACK_WEBHOOK_URL')
        
        if halftime_games and webhook_url:
            for game in halftime_games:
                # Create Slack message with rich formatting
                slack_message = {
                    "text": f"â° UNDER 10 MIN: {game['away_team']} {game['away_score']} - {game['home_score']} {game['home_team']} ({game['time_remaining']} left)",
                    "blocks": [
                        {
                            "type": "header",
                            "text": {
                                "type": "plain_text",
                                "text": "â° UNDER 10 MINUTES",
                                "emoji": True
                            }
                        },
                        {
                            "type": "section",
                            "fields": [
                                {
                                    "type": "mrkdwn",
                                    "text": f"*{game['away_team']}*\n{game['away_score']} points"
                                },
                                {
                                    "type": "mrkdwn",
                                    "text": f"*{game['home_team']}*\n{game['home_score']} points"
                                }
                            ]
                        },
                        {
                            "type": "context",
                            "elements": [
                                {
                                    "type": "mrkdwn",
                                    "text": f"â±ï¸ {game['time_remaining']} remaining â€¢ ðŸ“º {game['broadcast']}"
                                }
                            ]
                        }
                    ]
                }
                
                # Send to Slack
                req = urllib.request.Request(
                    webhook_url,
                    data=json.dumps(slack_message).encode('utf-8'),
                    headers={'Content-Type': 'application/json'}
                )
                
                try:
                    with urllib.request.urlopen(req) as response:
                        print(f"âœ“ Sent notification: {game['away_team']} vs {game['home_team']}")
                except Exception as e:
                    print(f"âœ— Error sending notification: {e}")
        else:
            print(f"\nNo NEW games at halftime right now.")
        
        # Save updated alerted games
        with open('alerted_games.txt', 'w') as f:
            f.write(','.join(sorted(alerted_games)))
        
        print(f"\nAlerted games today: {len(alerted_games)}")
        EOF
        
        # Run the Python script
        python3 check_halftime.py
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    
    - name: Commit state file
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add alerted_games.txt || true
        git commit -m "Update alerted games state [skip ci]" || true
        git push || true
