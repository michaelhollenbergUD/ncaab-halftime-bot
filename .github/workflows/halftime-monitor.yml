name: NCAAB Halftime Monitor

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  check-halftime:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check for halftime games
      run: |
        # Fetch ESPN scoreboard data
        response=$(curl -s "https://site.api.espn.com/apis/site/v2/sports/basketball/mens-college-basketball/scoreboard")
        
        # Save to file for processing
        echo "$response" > games.json
        
        # Create Python script to process data
        cat << 'EOF' > check_halftime.py
        import json
        import os
        import urllib.request
        import urllib.parse
        
        # Read the games data
        with open('games.json', 'r') as f:
            data = json.load(f)
        
        webhook_url = os.environ.get('SLACK_WEBHOOK_URL')
        
        # TEST MODE: Always send a test notification
        print("üß™ TEST MODE ENABLED - Sending test notification...")
        
        if webhook_url:
            # Create a test game
            test_game = {
                'away_team': 'Duke Blue Devils',
                'away_score': '42',
                'home_team': 'North Carolina Tar Heels',
                'home_score': '38',
                'broadcast': 'ESPN'
            }
            
            slack_message = {
                "text": f"üß™ TEST: üèÄ HALFTIME: {test_game['away_team']} {test_game['away_score']} - {test_game['home_score']} {test_game['home_team']}",
                "blocks": [
                    {
                        "type": "header",
                        "text": {
                            "type": "plain_text",
                            "text": "üß™ TEST - üèÄ HALFTIME",
                            "emoji": True
                        }
                    },
                    {
                        "type": "section",
                        "text": {
                            "type": "mrkdwn",
                            "text": "_This is a test notification. Your bot is working!_"
                        }
                    },
                    {
                        "type": "section",
                        "fields": [
                            {
                                "type": "mrkdwn",
                                "text": f"*{test_game['away_team']}*\n{test_game['away_score']} points"
                            },
                            {
                                "type": "mrkdwn",
                                "text": f"*{test_game['home_team']}*\n{test_game['home_score']} points"
                            }
                        ]
                    },
                    {
                        "type": "context",
                        "elements": [
                            {
                                "type": "mrkdwn",
                                "text": f"üì∫ {test_game['broadcast']}"
                            }
                        ]
                    }
                ]
            }
            
            # Send to Slack
            req = urllib.request.Request(
                webhook_url,
                data=json.dumps(slack_message).encode('utf-8'),
                headers={'Content-Type': 'application/json'}
            )
            
            try:
                with urllib.request.urlopen(req) as response:
                    print(f"‚úì Test notification sent successfully!")
                    print(f"‚úì When real games are at halftime, you'll see notifications like this")
            except Exception as e:
                print(f"‚úó Error sending notification: {e}")
        else:
            print("‚úó No webhook URL found!")
        
        # Also check real games
        halftime_games = []
        if 'events' in data and data['events']:
            for event in data['events']:
                competition = event['competitions'][0]
                status = competition['status']['type']['name']
                status_detail = competition['status']['type']['detail']
                
                if status == 'STATUS_HALFTIME' or 'halftime' in status_detail.lower():
                    home_team = next((t for t in competition['competitors'] if t['homeAway'] == 'home'), None)
                    away_team = next((t for t in competition['competitors'] if t['homeAway'] == 'away'), None)
                    
                    if home_team and away_team:
                        game = {
                            'away_team': away_team['team']['displayName'],
                            'away_score': away_team['score'],
                            'home_team': home_team['team']['displayName'],
                            'home_score': home_team['score'],
                            'broadcast': competition.get('broadcasts', [{}])[0].get('names', ['No TV info'])[0] if competition.get('broadcasts') else 'No TV info'
                        }
                        halftime_games.append(game)
        
        if halftime_games:
            print(f"\n‚úì Also found {len(halftime_games)} REAL game(s) at halftime!")
        else:
            print(f"\n‚ÑπÔ∏è No real games at halftime right now. Checked {len(data.get('events', []))} games.")
        EOF
        
        # Run the Python script
        python3 check_halftime.py
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
